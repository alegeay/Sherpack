{# ============================================
   DEPLOYMENT - Démonstration des fonctionnalités
   ============================================ #}

apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ release.name }}
  namespace: {{ release.namespace }}
  labels:
    app.kubernetes.io/name: {{ release.name }}
    app.kubernetes.io/version: {{ pack.version }}
    {#- Boucle sur les labels personnalisés -#}
    {% for key, value in values.labels | dictsort %}
    {{ key }}: {{ value | quote }}
    {% endfor %}
  annotations:
    {#- Boucle sur les annotations -#}
    {% for key, value in values.annotations | dictsort %}
    {{ key }}: {{ value | quote }}
    {% endfor %}
    {#- Annotation générée avec hash SHA256 -#}
    checksum/config: {{ values.config | tojson | sha256 | trunc(16) }}
spec:
  replicas: {{ values.app.replicas }}
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ release.name }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ release.name }}
    spec:
      containers:
        - name: {{ values.app.name | kebabcase }}
          image: {{ values.image.repository }}:{{ values.image.tag }}
          imagePullPolicy: {{ values.image.pullPolicy }}
          ports:
            {#- Boucle sur les ports -#}
            {% for p in values.ports %}
            - name: {{ p.name }}
              containerPort: {{ p.targetPort }}
              protocol: TCP
            {% endfor %}
          env:
            {#- Variables d'environnement depuis la map -#}
            {% for key, value in values.env | dictsort %}
            - name: {{ key }}
              value: {{ value | quote }}
            {% endfor %}
            {#- Variables calculées -#}
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: RELEASE_NAME
              value: {{ release.name | quote }}
          resources:
            {{ values.resources | toyaml | nindent(12) }}
          {#- Conditionnels -#}
          {% if values.features.caching %}
          volumeMounts:
            - name: cache
              mountPath: /var/cache
          {% endif %}
      {% if values.features.caching %}
      volumes:
        - name: cache
          emptyDir: {}
      {% endif %}
